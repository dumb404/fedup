<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Login</title>
  <!-- Include SheetJS library for XLSX functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      background-color: #f0f2f5;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      width: 100%;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 32px;
      margin: 20px auto;
    }
    .main-content {
      display: flex;
      justify-content: space-between;
      width: 100%;
    }
    .panel {
      flex: 1;
    }
    h2 {
      font-size: 28px;
      font-weight: 400;
      text-align: center;
      margin-bottom: 24px;
      color: #1a73e8;
    }
    h3 {
      font-size: 20px;
      font-weight: 400;
      margin: 20px 0 16px;
      color: #333;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    select, input, button {
      font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      font-size: 16px;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      width: 100%;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    select:focus, input:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }
    button {
      background-color: #1a73e8;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 400;
      padding: 12px;
      border-radius: 8px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1557b0;
    }
    .logout-btn {
      background-color: #d93025;
      margin-top: 20px;
      width: 100%;
    }
    .logout-btn:hover {
      background-color: #b3141a;
    }
    .error {
      color: #d93025;
      font-size: 14px;
      display: none;
      margin-top: -12px;
      margin-bottom: 12px;
    }
    a {
      color: #1a73e8;
      text-decoration: none;
      font-size: 14px;
      display: block;
      text-align: center;
      margin-top: 12px;
    }
    a:hover {
      text-decoration: underline;
    }
    footer {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-top: 24px;
    }
    #geoModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 1000;
    }
    #geoModal button {
      margin: 10px;
    }
    .notifications-box {
      flex: 0 0 300px;
      margin-left: 20px;
      background: #fff;
      border: 2px solid #1a73e8;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      height: fit-content;
      display: none; /* Hidden by default */
    }
    #adminPanel .notifications-box {
      display: block; /* Show only in adminPanel */
    }
    #adminNotifications p {
      margin: 10px 0;
      color: #d93025;
    }
    @media (max-width: 800px) {
      .main-content {
        flex-direction: column;
      }
      .notifications-box {
        margin-left: 0;
        margin-top: 20px;
        width: 100%;
      }
    }
    @media (max-width: 600px) {
      .container {
        padding: 24px;
      }
      h2 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="panel">
        <div id="registerSection" class="section">
          <h2 id="registerHeading">Registration</h2>
          <select id="registerType" onchange="toggleRegisterForm()">
            <option value="">-- Select --</option>
            <option value="user">User Registration</option>
            <option value="admin">Admin Registration</option>
          </select>
          <p id="dropdownError" class="error">Failed to load dropdown data. Using fallback data.</p>

          <form id="userRegisterForm" class="section" style="display: none;">
            <h3>User Registration</h3>
            <button type="button" onclick="document.getElementById('geoModal').style.display='block'">Set Location Manually</button>
            <label for="userEmail">Email</label>
            <input type="email" name="email" required>
            <span class="error" id="userEmailError">Please enter a valid email</span>

            <label for="userUsername">Username</label>
            <input type="text" name="username" required>

            <label for="userFirstName">First Name</label>
            <input type="text" name="first_name" required>

            <label for="userLastName">Last Name</label>
            <input type="text" name="last_name" required>

            <label for="userDrivingLicense">Driving License</label>
            <input type="text" name="driving_license">

            <label for="userNationalId">National ID</label>
            <input type="text" name="national_id">

            <label for="userNumberPlate">Number Plate</label>
            <input type="text" name="number_plate">

            <label for="userAddress">Address</label>
            <input type="text" name="address">

            <label for="userLocation">Location</label>
            <input type="text" name="location">

            <label for="userLatitude">Latitude</label>
            <input type="text" name="latitude">

            <label for="userLongitude">Longitude</label>
            <input type="text" name="longitude">

            <label for="userPassword">Password</label>
            <input type="password" name="password" required minlength="8">
            <span class="error" id="userPasswordError">Password must be at least 8 characters</span>

            <label for="userConfirmPassword">Confirm Password</label>
            <input type="password" name="confirm_password" required minlength="8">
            <span class="error" id="userConfirmPasswordError">Passwords do not match</span>

            <label for="userCountry">Country</label>
            <select name="country" required>
              <option value="">Select Country</option>
            </select>

            <label for="userEmergencyContact">Emergency Contact</label>
            <input type="text" name="emergency_contact_number">

            <label for="userRelatedEmergencyContact">Related Emergency Contact</label>
            <input type="text" name="emergency_contact_number_of_a_related_person">

            <button type="submit">Register</button>
            <span class="error" id="userRegisterError"></span>
            <a href="#" onclick="showSection('loginSection')">Already registered? Login</a>
          </form>

          <form id="adminRegisterForm" class="section" style="display: none;">
            <h3>Admin Registration</h3>
            <button type="button" onclick="document.getElementById('geoModal').style.display='block'">Set Location Manually</button>
            <label for="adminEmail">Email</label>
            <input type="email" name="email" required>
            <span class="error" id="adminEmailError">Please enter a valid email</span>

            <label for="adminUsername">Username</label>
            <input type="text" name="username" required>

            <label for="adminType">Admin Type</label>
            <select name="admin_type" required>
              <option value="">Select Type</option>
            </select>

            <label for="adminCountry">Country</label>
            <select name="country" required>
              <option value="">Select Country</option>
            </select>

            <label for="adminThana">Thana</label>
            <select name="thana" required>
              <option value="">Select Thana</option>
            </select>

            <label for="adminEmergencyResponse">Emergency Response</label>
            <input type="text" name="emergency_response">

            <label for="adminServiceInfo">Service Info</label>
            <input type="text" name="service_info">

            <label for="adminLatitude">Latitude</label>
            <input type="text" name="latitude">

            <label for="adminLongitude">Longitude</label>
            <input type="text" name="longitude">

            <label for="adminPassword">Password</label>
            <input type="password" name="password" required minlength="8">
            <span class="error" id="adminPasswordError">Password must be at least 8 characters</span>

            <label for="adminConfirmPassword">Confirm Password</label>
            <input type="password" name="confirm_password" required minlength="8">
            <span class="error" id="adminConfirmPasswordError">Passwords do not match</span>

            <button type="submit">Register</button>
            <span class="error" id="adminRegisterError"></span>
            <a href="#" onclick="showSection('loginSection')">Already registered? Login</a>
          </form>
        </div>

        <div id="loginSection" class="section active">
          <h2 id="loginHeading">Login</h2>
          <select id="loginType" onchange="toggleLoginForm()">
            <option value="">-- Select --</option>
            <option value="user">User Login</option>
            <option value="admin">Admin Login</option>
          </select>
          <p id="loginTypeError" class="error">Please select a login type.</p>

          <form id="userLoginForm" class="section" style="display: none;">
            <h3>User Login</h3>
            <label for="userLoginEmail">Email</label>
            <input type="email" name="email" required>
            <span class="error" id="userLoginEmailError">Please enter a valid email</span>

            <label for="userLoginPassword">Password</label>
            <input type="password" name="password" required minlength="8">
            <span class="error" id="userLoginPasswordError">Password must be at least 8 characters</span>

            <button type="submit">Login</button>
            <span class="error" id="userLoginError"></span>
            <a href="#" onclick="showSection('registerSection')">Not registered? Register</a>
          </form>

          <form id="adminLoginForm" class="section" style="display: none;">
            <h3>Admin Login</h3>
            <label for="adminLoginEmail">Email</label>
            <input type="email" name="email" required>
            <span class="error" id="adminLoginEmailError">Please enter a valid email</span>

            <label for="adminLoginPassword">Password</label>
            <input type="password" name="password" required minlength="8">
            <span class="error" id="adminLoginPasswordError">Password must be at least 8 characters</span>

            <label for="adminLoginType">Admin Type</label>
            <select name="admin_type" required>
              <option value="">Select Admin Type</option>
            </select>

            <button type="submit">Login</button>
            <span class="error" id="adminLoginError"></span>
            <a href="#" onclick="showSection('registerSection')">Not registered? Register</a>
          </form>
        </div>

        <div id="userPanel" class="section">
          <h2>R3sQ</h2>
          <div id="userData">
            <p><strong>Email:</strong> <span id="userEmailDisplay"></span></p>
            <p><strong>Username:</strong> <span id="userUsernameDisplay"></span></p>
            <p><strong>First Name:</strong> <span id="userFirstNameDisplay"></span></p>
            <p><strong>Last Name:</strong> <span id="userLastNameDisplay"></span></p>
            <p><strong>Driving License:</strong> <span id="userDrivingLicenseDisplay"></span></p>
            <p><strong>National ID:</strong> <span id="userNationalIdDisplay"></span></p>
            <p><strong>Number Plate:</strong> <span id="userNumberPlateDisplay"></span></p>
            <p><strong>Address:</strong> <span id="userAddressDisplay"></span></p>
            <p><strong>Location:</strong> <span id="userLocationDisplay"></span></p>
            <p><strong>Country:</strong> <span id="userCountryDisplay"></span></p>
            <p><strong>Emergency Contact:</strong> <span id="userEmergencyContactDisplay"></span></p>
            <p><strong>Related Emergency Contact:</strong> <span id="userRelatedEmergencyContactDisplay"></span></p>
            <p><strong>Latitude:</strong> <span id="userLatitudeDisplay"></span></p>
            <p><strong>Longitude:</strong> <span id="userLongitudeDisplay"></span></p>
          </div>

          <h3>Change Password</h3>
          <form id="userChangePasswordForm">
            <label for="userNewPassword">New Password</label>
            <input type="password" name="newPassword" required minlength="8">
            <span class="error" id="userChangePasswordError">Password must be at least 8 characters</span>
            <button type="submit">Change Password</button>
            <span class="error" id="userChangePasswordResult"></span>
          </form>

          <h3>Upload Profile Image</h3>
          <form id="userUploadImageForm" enctype="multipart/form-data">
            <input type="file" name="image" accept="image/*">
            <button type="submit">Upload Image</button>
            <span class="error" id="userUploadImageError"></span>
          </form>

          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div id="adminPanel" class="section">
          <h2>R3sQ</h2>
          <div id="adminData">
            <p><strong>Email:</strong> <span id="adminEmailDisplay"></span></p>
            <p><strong>Username:</strong> <span id="adminUsernameDisplay"></span></p>
            <p><strong>Admin Type:</strong> <span id="adminTypeDisplay"></span></p>
            <p><strong>Country:</strong> <span id="adminCountryDisplay"></span></p>
            <p><strong>Thana:</strong> <span id="adminThanaDisplay"></span></p>
            <p><strong>Emergency Response:</strong> <span id="adminEmergencyResponseDisplay"></span></p>
            <p><strong>Service Info:</strong> <span id="adminServiceInfoDisplay"></span></p>
            <p><strong>Latitude:</strong> <span id="adminLatitudeDisplay"></span></p>
            <p><strong>Longitude:</strong> <span id="adminLongitudeDisplay"></span></p>
          </div>

          <h3>Change Password</h3>
          <form id="adminChangePasswordForm">
            <label for="adminNewPassword">New Password</label>
            <input type="password" name="newPassword" required minlength="8">
            <span class="error" id="adminChangePasswordError">Password must be at least 8 characters</span>
            <button type="submit">Change Password</button>
            <span class="error" id="adminChangePasswordResult"></span>
          </form>

          <h3>Upload Profile Image</h3>
          <form id="adminUploadImageForm" enctype="multipart/form-data">
            <input type="file" name="image" accept="image/*">
            <button type="submit">Upload Image</button>
            <span class="error" id="adminUploadImageError"></span>
          </form>

          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
      <div class="notifications-box">
        <h3>Notifications and Alerts</h3>
        <div id="adminNotifications">
          <p><em>Nothing to show</em></p>
        </div>
      </div>
    </div>
    <footer>Â© 2025 R3sQ. All rights reserved.</footer>
  </div>

  <div id="geoModal" class="section" style="display: none;">
    <p>Allow us to access your location to auto-fill latitude and longitude?</p>
    <button onclick="allowGeo()">Allow</button>
    <button onclick="submit">Deny</button>
  </div>

  <script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function submit() { ...; }
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];

          // Convert sheet to JSON to filter out blank rows
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: header, blankrows: false, defval: '' });
          // Filter out blank rows (rows where all cells are empty, null, or undefined)
          var filteredData = jsonData.filter(row => row.some(filledCell));

          // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          // Fallback
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }

          // Convert filtered JSON back to CSV
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error(e);
          return "";
        }
      }
      return gk_fileData[filename] || "";
    }
  </script>

  <script>
    // Set your backend URL
    const backendUrl = 'https://fedup-1buq.onrender.com';

    // Show/hide sections and update titles
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');
      // Update page title and heading based on section
      if (sectionId === 'registerSection') {
        document.getElementById('pageTitle').textContent = 'Registration';
        document.getElementById('registerHeading').textContent = 'Registration';
      } else if (sectionId === 'loginSection') {
        document.getElementById('pageTitle').textContent = 'Login';
        document.getElementById('loginHeading').textContent = 'Login';
      } else if (sectionId === 'userPanel') {
        document.getElementById('pageTitle').textContent = 'R3sQ - User Panel';
        document.querySelector('#userPanel h2').textContent = 'R3sQ';
      } else if (sectionId === 'adminPanel') {
        document.getElementById('pageTitle').textContent = 'R3sQ - Admin Panel';
        document.querySelector('#adminPanel h2').textContent = 'R3sQ';
      }
      // Show geolocation modal only when on registration section
      if (sectionId === 'registerSection' && navigator.geolocation) {
        document.getElementById('geoModal').style.display = 'block';
      } else {
        document.getElementById('geoModal').style.display = 'none';
      }
      // Hide notifications box for non-admin sections
      const notificationsBox = document.querySelector('.notifications-box');
      if (sectionId !== 'adminPanel') {
        notificationsBox.style.display = 'none';
      } else {
        notificationsBox.style.display = 'block';
        fetchEmergencyMessages(); // Fetch notifications when entering adminPanel
      }
    }

    // Toggle registration forms
    function toggleRegisterForm() {
      const type = document.getElementById('registerType').value;
      document.getElementById('userRegisterForm').style.display = type === 'user' ? 'block' : 'none';
      document.getElementById('adminRegisterForm').style.display = type === 'admin' ? 'block' : 'none';
    }

    // Toggle login forms
    function toggleLoginForm() {
      console.log('toggleLoginForm called with value:', document.getElementById('loginType').value);
      const type = document.getElementById('loginType').value;
      const userForm = document.getElementById('userLoginForm');
      const adminForm = document.getElementById('adminLoginForm');
      const errorMsg = document.getElementById('loginTypeError');

      if (userForm && adminForm && errorMsg) {
        userForm.style.display = type === 'user' ? 'block' : 'none';
        adminForm.style.display = type === 'admin' ? 'block' : 'none';
        errorMsg.style.display = type === '' ? 'block' : 'none';
      } else {
        console.error('One or more elements not found:', { userForm, adminForm, errorMsg });
      }
    }

    // Load dropdowns with fallback data
    async function loadDropdowns() {
      // Fallback data in case fetch fails
      const fallbackCountries = ["Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Argentina", "Brazil", "Bangladesh", "Belgium", "Canada", "China", "Denmark", "Egypt", "France", "Germany", "India", "Indonesia", "Italy", "Japan", "Kenya", "Malaysia", "Mexico", "Nigeria", "Pakistan", "Russia", "South Africa", "South Korea", "Spain", "Thailand", "United Kingdom", "United States", "Vietnam"];
      const fallbackAdminOptions = {
        types: ["Hospital", "Police Station", "Mechanic Shop", "OGs"],
        thanas: ["Lalbag", "New Market", "Shahbag", "Hazaribag", "Dhanmondi", "Mohammadpur"]
      };

      let countries = fallbackCountries;
      let adminOptions = fallbackAdminOptions;

      try {
        console.log('Fetching countries.json from /public/countries.json');
        const countriesRes = await fetch('/public/countries.json');
        console.log('countriesRes status:', countriesRes.status);
        if (!countriesRes.ok) throw new Error(`Failed to fetch countries.json: ${countriesRes.statusText}`);

        console.log('Fetching adminOptions.json from /public/adminOptions.json');
        const adminOptionsRes = await fetch('/public/adminOptions.json');
        console.log('adminOptionsRes status:', adminOptionsRes.status);
        if (!adminOptionsRes.ok) throw new Error(`Failed to fetch adminOptions.json: ${adminOptionsRes.statusText}`);

        countries = await countriesRes.json();
        adminOptions = await adminOptionsRes.json();
        console.log('Successfully fetched data:', { countries, adminOptions });
      } catch (err) {
        console.error('Error loading dropdowns:', err);
        document.getElementById('dropdownError').textContent = 'Failed to load dropdown data. Using fallback data.';
        document.getElementById('dropdownError').style.display = 'block';
      }

      // Populate country dropdowns
      document.querySelectorAll('select[name="country"]').forEach(select => {
        select.innerHTML = '<option value="">Select Country</option>';
        countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          select.appendChild(option);
        });
      });

      // Populate admin type dropdowns (both registration and login)
      document.querySelectorAll('select[name="admin_type"]').forEach(select => {
        select.innerHTML = '<option value="">Select Type</option>';
        adminOptions.types.forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.textContent = type;
          select.appendChild(option);
        });
      });

      // Populate thana dropdown
      const thanaSelect = document.querySelector('select[name="thana"]');
      if (thanaSelect) {
        thanaSelect.innerHTML = '<option value="">Select Thana</option>';
        adminOptions.thanas.forEach(thana => {
          const option = document.createElement('option');
          option.value = thana;
          option.textContent = thana;
          thanaSelect.appendChild(option);
        });
      }
    }

    // Handle User Registration
    document.getElementById('userRegisterForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const errorElement = document.getElementById('userRegisterError');

      if (!data.email || !data.password || !data.username || !data.first_name || !data.last_name || !data.country) {
        errorElement.textContent = 'Please fill in all required fields.';
        errorElement.style.display = 'block';
        return;
      }

      if (data.password !== data.confirm_password) {
        document.getElementById('userConfirmPasswordError').style.display = 'block';
        errorElement.textContent = 'Passwords do not match.';
        errorElement.style.display = 'block';
        return;
      } else {
        document.getElementById('userConfirmPasswordError').style.display = 'none';
      }

      try {
        const response = await fetch(`${backendUrl}/register-user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...data, confirm_password: undefined })
        });
        const result = await response.text();
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
          e.target.reset();
          showSection('loginSection');
        } else {
          errorElement.textContent = result || 'Error registering user';
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error during user registration:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Handle Admin Registration
    document.getElementById('adminRegisterForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const errorElement = document.getElementById('adminRegisterError');

      if (!data.email || !data.password || !data.username || !data.admin_type || !data.country || !data.thana) {
        errorElement.textContent = 'Please fill in all required fields.';
        errorElement.style.display = 'block';
        return;
      }

      if (data.password !== data.confirm_password) {
        document.getElementById('adminConfirmPasswordError').style.display = 'block';
        errorElement.textContent = 'Passwords do not match.';
        errorElement.style.display = 'block';
        return;
      } else {
        document.getElementById('adminConfirmPasswordError').style.display = 'none';
      }

      try {
        const response = await fetch(`${backendUrl}/register-admin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...data, confirm_password: undefined })
        });
        const result = await response.text();
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
          e.target.reset();
          showSection('loginSection');
        } else {
          errorElement.textContent = result || 'Error registering admin';
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error during admin registration:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Handle User Login with improved error handling and email validation
    document.getElementById('userLoginForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const errorElement = document.getElementById('userLoginError');

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(data.email)) {
        errorElement.textContent = 'Please enter a valid email address.';
        errorElement.style.display = 'block';
        return;
      }

      try {
        console.log('Attempting user login with data:', data);
        const response = await fetch(`${backendUrl}/login-user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        console.log('User login response status:', response.status);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const result = await response.text();
        console.log('User login response text:', result);
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
          fetchUserData(data.email);
          showSection('userPanel');
        } else {
          errorElement.textContent = result || `Error logging in: HTTP ${response.status}`;
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error during user login:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please check if https://fedup-1buq.onrender.com is running and try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Handle Admin Login
    document.getElementById('adminLoginForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const errorElement = document.getElementById('adminLoginError');

      try {
        console.log('Attempting admin login with data:', data);
        const response = await fetch(`${backendUrl}/login-admin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        console.log('Admin login response status:', response.status);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const result = await response.text();
        console.log('Admin login response text:', result);
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
          fetchAdminData(data.email, data.admin_type);
          showSection('adminPanel');
          fetchEmergencyMessages(); // Fetch notifications after login
        } else {
          errorElement.textContent = result || `Error logging in: HTTP ${response.status}`;
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error during admin login:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please check if https://fedup-1buq.onrender.com is running and try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Fetch User Data
    async function fetchUserData(email) {
      try {
        const response = await fetch(`${backendUrl}/user-data`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const user = await response.json();
        if (response.ok) {
          document.getElementById('userEmailDisplay').textContent = user.email || '';
          document.getElementById('userUsernameDisplay').textContent = user.username || '';
          document.getElementById('userFirstNameDisplay').textContent = user.first_name || '';
          document.getElementById('userLastNameDisplay').textContent = user.last_name || '';
          document.getElementById('userDrivingLicenseDisplay').textContent = user.driving_license || '';
          document.getElementById('userNationalIdDisplay').textContent = user.national_id || '';
          document.getElementById('userNumberPlateDisplay').textContent = user.number_plate || '';
          document.getElementById('userAddressDisplay').textContent = user.address || '';
          document.getElementById('userLocationDisplay').textContent = user.location || '';
          document.getElementById('userCountryDisplay').textContent = user.country || '';
          document.getElementById('userEmergencyContactDisplay').textContent = user.emergency_contact_number || '';
          document.getElementById('userRelatedEmergencyContactDisplay').textContent = user.emergency_contact_number_of_a_related_person || '';
          document.getElementById('userLatitudeDisplay').textContent = user.latitude || '';
          document.getElementById('userLongitudeDisplay').textContent = user.longitude || '';
        } else {
          console.error('Failed to fetch user data:', await response.text());
        }
      } catch (err) {
        console.error('Error fetching user data:', err.message);
      }
    }

    // Fetch Admin Data
    async function fetchAdminData(email, admin_type) {
      try {
        const response = await fetch(`${backendUrl}/admin-data`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, admin_type })
        });
        const admin = await response.json();
        if (response.ok) {
          document.getElementById('adminEmailDisplay').textContent = admin.email || '';
          document.getElementById('adminUsernameDisplay').textContent = admin.username || '';
          document.getElementById('adminTypeDisplay').textContent = admin.admin_type || '';
          document.getElementById('adminCountryDisplay').textContent = admin.country || '';
          document.getElementById('adminThanaDisplay').textContent = admin.thana || '';
          document.getElementById('adminEmergencyResponseDisplay').textContent = admin.emergency_response || '';
          document.getElementById('adminServiceInfoDisplay').textContent = admin.service_info || '';
          document.getElementById('adminLatitudeDisplay').textContent = admin.latitude || '';
          document.getElementById('adminLongitudeDisplay').textContent = admin.longitude || '';
        } else {
          console.error('Failed to fetch admin data:', await response.text());
        }
      } catch (err) {
        console.error('Error fetching admin data:', err.message);
      }
    }

    // Fetch Emergency Messages
    async function fetchEmergencyMessages() {
      try {
        const response = await fetch(`${backendUrl}/get-emergency-messages`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        if (response.ok) {
          const messages = await response.json();
          const notificationsDiv = document.getElementById('adminNotifications');
          notificationsDiv.innerHTML = ''; // Clear existing messages
          if (messages.length > 0) {
            messages.forEach(message => {
              const p = document.createElement('p');
              p.textContent = message.text || 'No message content';
              p.style.color = '#d93025'; // Red for urgency
              notificationsDiv.appendChild(p);
            });
          } else {
            notificationsDiv.innerHTML = '<p><em>Nothing to show</em></p>';
          }
        } else {
          console.error('Failed to fetch emergency messages:', await response.text());
          document.getElementById('adminNotifications').innerHTML = '<p><em>Nothing to show</em></p>';
        }
      } catch (err) {
        console.error('Error fetching emergency messages:', err.message);
        document.getElementById('adminNotifications').innerHTML = '<p><em>Nothing to show</em></p>';
      }
    }

    // Poll for new messages every 30 seconds
    setInterval(fetchEmergencyMessages, 30000);

    // Handle User Change Password
    document.getElementById('userChangePasswordForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const email = document.getElementById('userEmailDisplay').textContent;
      const errorElement = document.getElementById('userChangePasswordResult');

      if (!data.newPassword || data.newPassword.length < 8) {
        errorElement.textContent = 'Password must be at least 8 characters.';
        errorElement.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${backendUrl}/change-password-user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword: data.newPassword })
        });
        const result = await response.text();
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
        } else {
          errorElement.textContent = result || 'Error changing password';
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error changing user password:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Handle Admin Change Password
    document.getElementById('adminChangePasswordForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const email = document.getElementById('adminEmailDisplay').textContent;
      const admin_type = document.getElementById('adminTypeDisplay').textContent;
      const errorElement = document.getElementById('adminChangePasswordResult');

      if (!data.newPassword || data.newPassword.length < 8) {
        errorElement.textContent = 'Password must be at least 8 characters.';
        errorElement.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${backendUrl}/change-password-admin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, newPassword: data.newPassword, admin_type })
        });
        const result = await response.text();
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
        } else {
          errorElement.textContent = result || 'Error changing password';
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error changing admin password:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Handle User Upload Image
    document.getElementById('userUploadImageForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const email = document.getElementById('userEmailDisplay').textContent;
      const errorElement = document.getElementById('userUploadImageError');

      try {
        const response = await fetch(`${backendUrl}/upload-image-user`, {
          method: 'POST',
          body: formData
        });
        const result = await response.text();
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
          fetchUserData(email); // Refresh user data to update image
        } else {
          errorElement.textContent = result || 'Error uploading image';
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error uploading user image:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Handle Admin Upload Image
    document.getElementById('adminUploadImageForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const email = document.getElementById('adminEmailDisplay').textContent;
      const admin_type = document.getElementById('adminTypeDisplay').textContent;
      const errorElement = document.getElementById('adminUploadImageError');

      try {
        const response = await fetch(`${backendUrl}/upload-image-admin`, {
          method: 'POST',
          body: formData
        });
        const result = await response.text();
        if (response.ok) {
          errorElement.textContent = result;
          errorElement.style.color = 'green';
          errorElement.style.display = 'block';
          fetchAdminData(email, admin_type); // Refresh admin data to update image
        } else {
          errorElement.textContent = result || 'Error uploading image';
          errorElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error uploading admin image:', err.message);
        errorElement.textContent = `Failed to connect to the server: ${err.message}. Please try again.`;
        errorElement.style.display = 'block';
      }
    });

    // Logout Function
    function logout() {
      showSection('loginSection');
      document.getElementById('userLoginError').style.display = 'none';
      document.getElementById('adminLoginError').style.display = 'none';
      document.getElementById('userData').innerHTML = '';
      document.getElementById('adminData').innerHTML = '';
      document.getElementById('adminNotifications').innerHTML = '<p><em>Nothing to show</em></p>';
    }

    // Geolocation Handling
    function allowGeo() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            document.querySelectorAll('input[name="latitude"]').forEach(input => input.value = latitude);
            document.querySelectorAll('input[name="longitude"]').forEach(input => input.value = longitude);
            document.getElementById('geoModal').style.display = 'none';
          },
          (error) => {
            console.error('Geolocation error:', error.message);
            document.getElementById('geoModal').style.display = 'none';
            alert('Unable to retrieve your location. Please enter manually.');
          }
        );
      } else {
        alert('Geolocation is not supported by this browser.');
        document.getElementById('geoModal').style.display = 'none';
      }
    }

    // Load dropdowns and initial state
    document.addEventListener('DOMContentLoaded', () => {
      loadDropdowns();
      toggleLoginForm(); // Ensure login form is initialized
    });
  </script>
</body>
</html>